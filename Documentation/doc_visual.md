---
title: "doc"
output: html_document
---

# Документация: test-visualization-standalone.R

## Назначение

`test-visualization-standalone.R` — автономный тестовый скрипт для проверки визуализаций и базовой обработки данных в R без обязательной установки всего пакета `arxivThreatIntel` и без зависимости от интернета.

Скрипт:

- Использует **реальные данные** из arXiv, если доступен пакет `arxivThreatIntel` и интернет.
- Переходит на **mock-данные**, если пакет недоступен или функции сбора/фильтрации не определены.



## Когда использовать

Используйте `test-visualization-standalone.R`, когда:

- Нужно быстро проверить, что визуализации и базовая обработка данных работают на текущей машине.
- Пакет `arxivThreatIntel` еще не установлен или не собран как полноценный R-пакет.
- Нет доступа к интернету, но необходимо протестировать логику построения графиков.
- Требуется демонстрация функционала (статистика + графики) без запуска полной ETL-цепочки (`collect_data.R`, DuckDB, Parquet).



## Зависимости

Обязательные пакеты:

- `dplyr`  
- `ggplot2`

Установить (при необходимости):

install.packages("dplyr")
install.packages("ggplot2")



Опционально:

- `arxivThreatIntel` — для использования реальных данных из arXiv (если установлен, скрипт автоматически их использует).



## Как запустить

### Вариант 1: Через source()

source("tests/manual/test-visualization-standalone.R")



Результат:

- В консоли — пошаговый лог с пометками УСПЕХ / ОШИБКА.  
- В панели Plots/Viewer — несколько графиков (p1, p2, p3, p4).

### Вариант 2: Через RStudio

1. Откройте `test-visualization-standalone.R` в RStudio.  
2. Нажмите Ctrl + A (выделить весь файл).  
3. Нажмите Ctrl + Enter (выполнить).  
4. Смотрите вывод в Console и графики в Plots/Viewer.

### Вариант 3: Построчный запуск

1. Откройте файл в RStudio.  
2. Перемещайте курсор по блокам кода.  
3. Нажимайте Ctrl + Enter для поэтапного выполнения и анализа каждого теста.



## Логика работы скрипта

### Шаг 1: Загрузка библиотек

Скрипт подключает:

library(dplyr)
library(ggplot2)



и выводит статус в консоль.

Если один из пакетов отсутствует, выполнение прекращается с явной ошибкой подключения.

### Шаг 2: Подготовка данных

Стратегия «best effort»:

1. Попытка использовать реальные данные:
   - Подключить `arxivThreatIntel`.  
   - Вызвать:
     - `fetch_arxiv_data()` — загрузка публикаций из arXiv.
     - `filter_cybersecurity()` — фильтрация по кибербезопасности.
     - `categorize_articles()` — категоризация статей.
   - Если успешно — формируются:
     - `categorized_primary` — по одной категории на статью.  
     - `categorized_multi` — статьи с несколькими категориями.

2. Если шаг 1 не удался — создание mock-данных:
   - Генерируется примерно 87 записей с полями:
     - id, title, abstract, published, security_category.
   - Используются 5–6 категорий безопасности (например, Cryptography, Network Security, Malware Analysis и др.).
   - Даты публикации равномерно распределены в диапазоне 2024–2025 годов.

Результат:

- Всегда есть валидные данные для теста, даже без пакета и интернета.



## Структура тестов

Внутри `test-visualization-standalone.R` реализовано 8 логических тестов.

### Тест 1: Статистика категорий

- Группировка по security_category.  
- Подсчет количества статей на категорию.  
- Сортировка по убыванию.  
- Вывод топ-3 категорий в консоль.

Назначение: Проверить корректность агрегирования и базовой обработки табличных данных.

### Тест 2: Горизонтальная столбчатая диаграмма

- Использует агрегированную статистику.  
- Строит ggplot с geom_col(), coord_flip(), заголовком.

Проверяется: Формирование корректного объекта ggplot.

### Тест 3: Временная диаграмма по месяцам

- Преобразует published в начало месяца (месячная агрегация).  
- Считает количество публикаций по месяцам.
- Строит столбчатый график с цветовой заливкой через scale_fill_viridis_c().

Проверяется: Работа с датами и временными группировками.

### Тест 4: Кастомизация графика

- Берет топ-8 категорий по количеству.  
- Строит диаграмму с scale_fill_viridis_d(), theme_dark(), увеличенным заголовком.

Проверяется: Применение цветовых палитр и тем.

### Тест 5: Фасетирование

- Формирует facet_data с ограничением на 4 верхние категории.
- Строит facet_wrap(~security_category, scales = "free_y").

Проверяется: Корректная работа фасетирования и раздельные масштабы.

### Тест 6: Обработка NULL

- Передает NULL в контекст ggplot() внутри tryCatch.  
- Фиксирует поведение и выводит сообщение.

Проверяется: Поведение визуализаций на некорректном вводе.

### Тест 7: Обработка пустого датафрейма

- Создает empty_df <- categorized_primary[0, ].  
- Пытается построить график на основе пустых данных.

Проверяется: Поведение кода при отсутствии данных.

### Тест 8: Сохранение графика в файл

- Использует tempfile(fileext = ".png").  
- Вызывает ggsave() для графика p1.
- Проверяет существование файла, ненулевой размер, успешное удаление.

Проверяется: Экспорт графики в PNG и работа диска.



## Итоговый отчет

В конце скрипт выводит:

- Список тестов с пометками при успехе.
- Суммарный статус:
  - «Все основные функции ggplot2 работают: ДА»  
  - «Граничные случаи обработаны: ДА»
- Информацию о наборе данных:
  - количество статей в categorized_primary;  
  - количество уникальных категорий;  
  - диапазон дат публикации.
- Примечание, использовались ли mock-данные или реальные данные из arXiv.



## Связь с остальной кодовой базой

`test-visualization-standalone.R` дополняет существующую структуру:

- Автоматические тесты (tests/testthat/*.R) проверяют функции пакета с использованием testthat фреймворка.
- Данный скрипт:
  - не использует testthat;  
  - предназначен для ручного запуска;  
  - удобен для быстрой проверки окружения и демонстрации визуализаций новым участникам команды.
  - может запускаться в RStudio без дополнительной конфигурации.



## Рекомендуемый путь и имя

Рекомендуется разместить файл:

- Скрипт: tests/manual/test-visualization-standalone.R  
- Документация (этот файл): tests/manual/test-visualization-standalone.md  



## Часто задаваемые вопросы

### Почему тест не работает без интернета?

Если вы хотите использовать реальные данные из arXiv, нужен интернет. Но скрипт автоматически переключается на mock-данные, если:
- Нет соединения с интернетом
- Пакет arxivThreatIntel не установлен
- Функции сбора данных недоступны

### Почему я вижу ошибку "No package called 'dplyr'"?

Установите недостающие пакеты:
install.packages(c("dplyr", "ggplot2"))



### Могу ли я добавить свои тесты?

Да! Просто добавьте новый блок кода с аналогичной структурой:
cat("================== ТЕСТ N ==================\n")

ваш код здесь
cat("РЕЗУЛЬТАТ\n\n")



### Как сохранить результаты в файл?

Используйте sink():
sink("test_results.txt")
source("test-visualization-standalone.R")
sink()

